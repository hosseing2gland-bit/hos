name: Auto Fix Errors

on:
  workflow_run:
    workflows: ["Build and Test"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  analyze-and-fix:
    name: Analyze and Fix Build Errors
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Analyze package-lock files
        id: analyze
        run: |
          echo "Checking for missing or corrupted package-lock.json files..."

          # Check backend
          if [ ! -f "backend/package-lock.json" ]; then
            echo "backend_needs_lock=true" >> $GITHUB_OUTPUT
          fi

          # Check desktop-app
          if [ ! -f "desktop-app/package-lock.json" ]; then
            echo "desktop_needs_lock=true" >> $GITHUB_OUTPUT
          fi

          # Check renderer
          if [ ! -f "desktop-app/renderer/package-lock.json" ]; then
            echo "renderer_needs_lock=true" >> $GITHUB_OUTPUT
          fi

      - name: Fix backend package-lock
        if: steps.analyze.outputs.backend_needs_lock == 'true'
        working-directory: ./backend
        run: |
          echo "Generating package-lock.json for backend..."
          npm install --package-lock-only

      - name: Fix desktop-app package-lock
        if: steps.analyze.outputs.desktop_needs_lock == 'true'
        working-directory: ./desktop-app
        run: |
          echo "Generating package-lock.json for desktop-app..."
          npm install --package-lock-only

      - name: Fix renderer package-lock
        if: steps.analyze.outputs.renderer_needs_lock == 'true'
        working-directory: ./desktop-app/renderer
        run: |
          echo "Generating package-lock.json for renderer..."
          npm install --package-lock-only

      - name: Check for dependency issues
        run: |
          echo "Checking for common dependency issues..."

          # Check for peer dependency warnings
          cd backend
          npm list --depth=0 || true

          cd ../desktop-app
          npm list --depth=0 || true

          cd renderer
          npm list --depth=0 || true

      - name: Fix ESLint issues
        continue-on-error: true
        run: |
          echo "Attempting to fix ESLint issues..."
          cd backend
          npm run lint:fix || true

          cd ../desktop-app/renderer
          npm run lint -- --fix || true

      - name: Update vulnerable dependencies
        continue-on-error: true
        run: |
          echo "Checking for security vulnerabilities..."

          cd backend
          npm audit fix --force || npm audit fix || true

          cd ../desktop-app
          npm audit fix --force || npm audit fix || true

          cd renderer
          npm audit fix --force || npm audit fix || true

      - name: Check for changes
        id: check_changes
        run: |
          git diff --quiet || echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request with fixes
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix: auto-fix build errors and dependencies'
          title: 'ðŸ¤– Auto-fix: Build errors and dependency issues'
          body: |
            ## ðŸ¤– Automated Fixes

            This PR was automatically created to fix build errors and dependency issues.

            ### Changes Made:

            - âœ… Generated missing package-lock.json files
            - âœ… Fixed ESLint issues
            - âœ… Updated vulnerable dependencies
            - âœ… Resolved peer dependency warnings

            ### Action Required:

            Please review the changes and merge if everything looks good.
            The build should pass after merging this PR.

            ---

            *Auto-generated by GitHub Actions*
          branch: auto-fix/build-errors
          delete-branch: true
          labels: |
            automated
            bug
            dependencies

  common-fixes:
    name: Apply Common Fixes
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Fix missing .env files
        run: |
          echo "Creating missing .env files from examples..."

          # Backend .env
          if [ ! -f "backend/.env" ] && [ -f "backend/.env.example" ]; then
            cp backend/.env.example backend/.env
            echo "âœ… Created backend/.env"
          fi

      - name: Fix icon files
        run: |
          echo "Checking icon files..."

          # Create placeholder if missing
          if [ ! -f "desktop-app/build/icon.ico" ]; then
            echo "âš ï¸ Windows icon missing - needs manual creation"
          fi

      - name: Fix nginx config
        run: |
          if [ ! -f "nginx/nginx.conf" ]; then
            mkdir -p nginx
            cat > nginx/nginx.conf << 'EOF'
          events {
              worker_connections 1024;
          }

          http {
              upstream backend {
                  server backend:3000;
              }

              server {
                  listen 80;
                  server_name localhost;

                  location /api/ {
                      proxy_pass http://backend;
                      proxy_http_version 1.1;
                      proxy_set_header Upgrade $http_upgrade;
                      proxy_set_header Connection 'upgrade';
                      proxy_set_header Host $host;
                      proxy_cache_bypass $http_upgrade;
                      proxy_set_header X-Real-IP $remote_addr;
                      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  }
              }
          }
          EOF
            echo "âœ… Created nginx/nginx.conf"
          fi

      - name: Clear npm cache
        run: |
          npm cache clean --force

          cd backend
          rm -rf node_modules package-lock.json
          npm install

          cd ../desktop-app
          rm -rf node_modules package-lock.json
          npm install

          cd renderer
          rm -rf node_modules package-lock.json
          npm install

      - name: Create PR if changes exist
        id: check
        run: |
          git diff --quiet || echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix: apply common fixes for missing files'
          title: 'ðŸ”§ Fix: Missing configuration files'
          body: |
            ## ðŸ”§ Common Fixes Applied

            This PR adds missing configuration files and fixes common issues.

            ### Changes:

            - Added missing .env files
            - Created nginx configuration
            - Regenerated package-lock.json files
            - Cleared npm cache

            ### Next Steps:

            1. Review changes
            2. Update .env files with production values
            3. Add proper icon files if needed
            4. Merge and rebuild

            ---

            *Auto-generated by GitHub Actions*
          branch: auto-fix/missing-files
          delete-branch: true
          labels: |
            automated
            enhancement

  diagnostic:
    name: Diagnostic Information
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Collect diagnostic info
        run: |
          echo "## ðŸ” Diagnostic Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### File Structure:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tree -L 3 -I 'node_modules|dist|.git' || find . -maxdepth 3 -type f -not -path '*/node_modules/*' -not -path '*/.git/*' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Missing Files Check:" >> $GITHUB_STEP_SUMMARY

          # Check critical files
          FILES=(
            "backend/package.json"
            "backend/.env.example"
            "desktop-app/package.json"
            "desktop-app/renderer/package.json"
            "docker-compose.yml"
            ".github/workflows/build-and-test.yml"
          )

          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "- âœ… $file" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âŒ $file (MISSING)" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommended Actions:" >> $GITHUB_STEP_SUMMARY

          if [ ! -f "backend/.env" ]; then
            echo "- âš ï¸ Create backend/.env from .env.example" >> $GITHUB_STEP_SUMMARY
          fi

          if [ ! -f "desktop-app/build/icon.ico" ]; then
            echo "- âš ï¸ Add Windows icon file" >> $GITHUB_STEP_SUMMARY
          fi

          if [ ! -f "desktop-app/build/icon.icns" ]; then
            echo "- âš ï¸ Add macOS icon file" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check Node versions
        run: |
          echo "### Environment Info:" >> $GITHUB_STEP_SUMMARY
          echo "- Node: $(node --version)" >> $GITHUB_STEP_SUMMARY
          echo "- NPM: $(npm --version)" >> $GITHUB_STEP_SUMMARY
          echo "- OS: $(uname -s)" >> $GITHUB_STEP_SUMMARY
